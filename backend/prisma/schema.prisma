// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  PME
  EXPERT
  ADMIN
}

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  password String
  name     String
  phone    String?
  role     Role    @default(PME)

  societesPossedees Societe[] @relation("OwnerSocietes")
  alertes           Alerte[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Societe {
  id                 String  @id @default(cuid())
  nom                String
  rccm               String?
  compteContribuable String?
  regimeTva          String?
  adresse            String?
  pays               String? @default("Côte d'Ivoire")

  ownerId String
  owner   User   @relation("OwnerSocietes", fields: [ownerId], references: [id])

  clients             Client[]
  factures            Facture[]
  devis               Devis[]
  recettes            Recette[]
  depenses            Depense[]
  notesFrais          NoteFrais[]
  comptesBancaires    CompteBancaire[]
  ecrituresComptables EcritureComptable[]
  declarationsTVA     DeclarationTVA[]
  declarationsFiscales DeclarationFiscale[]
  echeancesFiscales   EcheanceFiscale[]
  alertes             Alerte[]
  exercices           Exercice[]
  documents           Document[]
  rapprochementsFacture RapprochementFacture[]
  budgets             Budget[]
  produits            Produit[]
  mouvementsStock     MouvementStock[]
  inventaires         Inventaire[]
  immobilisations     Immobilisation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Budget {
  id             String   @id @default(cuid())
  societeId      String
  annee          Int      // Année concernée (ex: 2026)
  budgetRecettes Decimal  @default(0) // Budget recettes annuel (FCFA)
  budgetDepenses Decimal  @default(0) // Budget dépenses annuel (FCFA)

  societe Societe @relation(fields: [societeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([societeId, annee])
  @@index([societeId])
}

model Produit {
  id              String   @id @default(cuid())
  societeId       String
  reference       String   // Référence produit (ex: REF-001)
  designation     String   // Désignation / libellé
  unite           String   @default("PIECE") // PIECE, KG, LITRE, METRE, etc.
  quantiteEnStock Decimal  @default(0)
  seuilAlerte     Decimal? // Alerte si stock < seuil

  societe         Societe          @relation(fields: [societeId], references: [id], onDelete: Cascade)
  mouvementsStock MouvementStock[]
  lignesInventaire LigneInventaire[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([societeId, reference])
  @@index([societeId])
}

model MouvementStock {
  id         String   @id @default(cuid())
  societeId  String
  produitId  String
  type       String   // ENTREE, SORTIE
  quantite   Decimal
  date       DateTime
  libelle    String?  // Référence facture, bon de livraison, etc.

  societe Societe @relation(fields: [societeId], references: [id], onDelete: Cascade)
  produit Produit @relation(fields: [produitId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([societeId])
  @@index([produitId])
}

model Inventaire {
  id           String   @id @default(cuid())
  societeId    String
  dateInventaire DateTime
  statut       String   @default("BROUILLON") // BROUILLON, CLOTURE
  commentaire  String?

  societe          Societe          @relation(fields: [societeId], references: [id], onDelete: Cascade)
  lignesInventaire LigneInventaire[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId])
}

model LigneInventaire {
  id               String   @id @default(cuid())
  inventaireId     String
  produitId        String
  quantiteComptee  Decimal  // Quantité comptée physiquement
  quantiteSysteme  Decimal  // Quantité en stock au moment du comptage

  inventaire Inventaire @relation(fields: [inventaireId], references: [id], onDelete: Cascade)
  produit    Produit    @relation(fields: [produitId], references: [id], onDelete: Cascade)

  @@unique([inventaireId, produitId])
  @@index([inventaireId])
}

model Immobilisation {
  id               String   @id @default(cuid())
  societeId        String
  designation      String   // Désignation du bien (ex: Véhicule Toyota)
  categorie        String   // VEHICULE, MATERIEL_INFORMATIQUE, MOBILIER, BATIMENT, AUTRE
  dateAcquisition  DateTime // Date d'acquisition
  valeurOrigine    Decimal  // Valeur d'origine (FCFA)
  dureeAnnees      Int      // Durée d'utilisation en années (SYSCOHADA)
  methode          String   @default("LINEAIRE") // Méthode d'amortissement
  commentaire      String?

  societe Societe @relation(fields: [societeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId])
}

model Client {
  id        String  @id @default(cuid())
  societeId String
  nom       String
  adresse   String?
  email     String?
  telephone String?
  numeroCc  String?

  societe  Societe   @relation(fields: [societeId], references: [id])
  factures Facture[]
  devis    Devis[]
}

model Facture {
  id        String   @id @default(cuid())
  societeId String
  clientId  String
  numero    String   @unique
  date      DateTime
  statut    String   @default("BROUILLON") // BROUILLON, ENVOYEE, PAYEE, ANNULEE

  // Multi-devises
  deviseId  String?  // Code devise (XOF, EUR, USD) - null = XOF par défaut
  tauxChange Decimal? // Taux de change au moment de la création (1 devise = X XOF)
  montantDeviseEtrangere Decimal? // Montant dans la devise étrangère (si différent de XOF)

  totalHT  Decimal @default(0)
  totalTVA Decimal @default(0)
  totalTTC Decimal @default(0)

  societe            Societe                @relation(fields: [societeId], references: [id])
  client             Client                 @relation(fields: [clientId], references: [id])
  lignes             FactureLigne[]
  devis              Devis?                 @relation // Si créé depuis un devis
  paiements          Paiement[]
  rapprochementsFacture RapprochementFacture[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FactureLigne {
  id           String  @id @default(cuid())
  factureId    String
  designation  String
  quantite     Int
  prixUnitaire Decimal
  tauxTVA      Decimal @default(0)
  montantHT    Decimal
  montantTVA   Decimal
  montantTTC   Decimal

  facture Facture @relation(fields: [factureId], references: [id])
}

model Devis {
  id           String    @id @default(cuid())
  societeId    String
  clientId     String
  numero       String    @unique
  date         DateTime
  dateValidite DateTime? // Date limite de validité du devis
  statut       String    @default("BROUILLON") // BROUILLON, ENVOYE, ACCEPTE, REFUSE, CONVERTI
  factureId    String?   @unique // Si converti en facture, référence à la facture créée

  totalHT  Decimal @default(0)
  totalTVA Decimal @default(0)
  totalTTC Decimal @default(0)

  societe Societe      @relation(fields: [societeId], references: [id])
  client  Client       @relation(fields: [clientId], references: [id])
  facture Facture?     @relation(fields: [factureId], references: [id])
  lignes  DevisLigne[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DevisLigne {
  id           String  @id @default(cuid())
  devisId      String
  designation  String
  quantite     Int
  prixUnitaire Decimal
  tauxTVA      Decimal @default(0)
  montantHT    Decimal
  montantTVA   Decimal
  montantTTC   Decimal

  devis Devis @relation(fields: [devisId], references: [id], onDelete: Cascade)
}

model Recette {
  id          String   @id @default(cuid())
  societeId   String
  date        DateTime
  montant     Decimal
  description String?

  societe             Societe              @relation(fields: [societeId], references: [id])
  transactionBancaire TransactionBancaire? @relation("RecetteTransaction")
}

model Depense {
  id          String   @id @default(cuid())
  societeId   String
  date        DateTime
  montant     Decimal
  description String?

  societe             Societe              @relation(fields: [societeId], references: [id])
  transactionBancaire TransactionBancaire? @relation("DepenseTransaction")
}

model NoteFrais {
  id              String   @id @default(cuid())
  societeId       String
  date            DateTime
  montant         Decimal
  description     String?
  categorie       String? // Ex: Transport, Repas, Hébergement, etc.
  statut          String   @default("BROUILLON") // BROUILLON, EN_ATTENTE, VALIDEE, REFUSEE
  justificatifUrl String? // URL du fichier justificatif (si upload)

  societe Societe @relation(fields: [societeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompteBancaire {
  id           String  @id @default(cuid())
  societeId    String
  nom          String // Ex: "Compte principal", "Compte épargne"
  banque       String? // Nom de la banque
  numeroCompte String? // Numéro de compte
  iban         String? // IBAN (optionnel)
  devise       String  @default("FCFA") // FCFA, EUR, USD, etc.
  soldeInitial Decimal @default(0) // Solde initial du compte
  actif        Boolean @default(true) // Compte actif ou archivé

  societe      Societe               @relation(fields: [societeId], references: [id])
  transactions TransactionBancaire[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TransactionBancaire {
  id               String   @id @default(cuid())
  compteBancaireId String
  date             DateTime
  montant          Decimal
  libelle          String // Description de la transaction
  type             String // DEBIT, CREDIT
  categorie        String? // Ex: Virement, Prélèvement, Chèque, Carte, etc.
  reference        String? // Référence bancaire
  rapproche        Boolean  @default(false) // Si la transaction est rapprochée
  recetteId        String?  @unique // Lien vers recette si rapprochée
  depenseId        String?  @unique // Lien vers dépense si rapprochée

  compteBancaire      CompteBancaire         @relation(fields: [compteBancaireId], references: [id])
  recette             Recette?               @relation("RecetteTransaction", fields: [recetteId], references: [id])
  depense             Depense?               @relation("DepenseTransaction", fields: [depenseId], references: [id])
  rapprochementsFacture RapprochementFacture[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompteComptable {
  id        String  @id @default(cuid())
  code      String  @unique // Code du compte (ex: "411", "701")
  libelle   String // Libellé du compte
  classe    Int // Classe SYSCOHADA (1-9)
  type      String // ACTIF, PASSIF, CHARGE, PRODUIT
  collectif Boolean @default(false) // Si c'est un compte collectif
  parentId  String? // Compte parent (pour hiérarchie)

  parent          CompteComptable?    @relation("CompteHierarchy", fields: [parentId], references: [id])
  enfants         CompteComptable[]   @relation("CompteHierarchy")
  ecrituresDebit  EcritureComptable[] @relation("CompteDebit")
  ecrituresCredit EcritureComptable[] @relation("CompteCredit")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Exercice {
  id          String    @id @default(cuid())
  societeId   String
  annee       Int // Année de l'exercice (ex: 2024)
  dateDebut   DateTime // Date de début de l'exercice
  dateFin     DateTime // Date de fin de l'exercice
  statut      String    @default("OUVERT") // OUVERT, FERME
  dateCloture DateTime? // Date de clôture de l'exercice

  societe   Societe             @relation(fields: [societeId], references: [id])
  ecritures EcritureComptable[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([societeId, annee])
  @@index([societeId, statut])
}

model EcritureComptable {
  id                 String   @id @default(cuid())
  societeId          String
  exerciceId         String? // Exercice auquel appartient l'écriture
  compteDebitId      String
  compteCreditId     String
  date               DateTime
  montant            Decimal
  libelle            String
  pieceJustificative String? // Référence (facture, transaction, etc.)
  journal            String? // Journal comptable (Ventes, Achats, Banque, etc.)

  societe      Societe         @relation(fields: [societeId], references: [id])
  exercice     Exercice?       @relation(fields: [exerciceId], references: [id])
  compteDebit  CompteComptable @relation("CompteDebit", fields: [compteDebitId], references: [id])
  compteCredit CompteComptable @relation("CompteCredit", fields: [compteCreditId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeclarationTVA {
  id              String   @id @default(cuid())
  societeId       String
  periode         String // Format: "YYYY-MM" (ex: "2024-01")
  dateDeclaration DateTime @default(now())
  statut          String   @default("BROUILLON") // BROUILLON, ENVOYEE, VALIDEE

  // TVA collectée (sur les ventes)
  tvaCollectee Decimal @default(0)

  // TVA déductible (sur les achats)
  tvaDeductible Decimal @default(0)

  // TVA à payer
  tvaAPayer Decimal @default(0)

  // Détails
  montantHTVentes  Decimal @default(0)
  montantTTCVentes Decimal @default(0)
  montantHTAchats  Decimal @default(0)
  montantTTCAchats Decimal @default(0)

  societe Societe @relation(fields: [societeId], references: [id])
  echeancesFiscales EcheanceFiscale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeclarationFiscale {
  id              String   @id @default(cuid())
  societeId       String
  type            String   // TVA, IS, CNPS, RETENUE_SOURCE, BIC
  periode         String   // Format: "YYYY-MM" pour mensuel, "YYYY" pour annuel
  dateDeclaration DateTime @default(now())
  statut          String   @default("BROUILLON") // BROUILLON, ENVOYEE, VALIDEE, REJETEE
  
  // Données JSON pour flexibilité selon le type
  donnees         Json     // Structure variable selon le type de déclaration
  
  // Validation
  validee         Boolean  @default(false)
  dateValidation  DateTime?
  validateurId    String?  // ID de l'utilisateur qui a validé
  
  // Export
  fichierPDF      String?  // Chemin vers le PDF généré
  fichierXML      String?  // Chemin vers le XML DGI (si applicable)
  referenceDGI    String?  // Numéro de référence DGI après dépôt
  
  // Notes et commentaires
  notes           String?
  erreurs         Json?    // Liste des erreurs détectées lors de la validation
  
  societe Societe @relation(fields: [societeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId, type])
  @@index([societeId, periode])
  @@index([societeId, statut])
  @@index([type, periode])
}

model Paiement {
  id        String   @id @default(cuid())
  factureId String
  date      DateTime
  montant   Decimal
  methode   String // ESPECES, VIREMENT, CHEQUE, CARTE, AUTRE
  reference String? // Numéro de chèque, référence virement, etc.
  notes     String? // Commentaires optionnels

  facture              Facture              @relation(fields: [factureId], references: [id])
  rapprochementsFacture RapprochementFacture[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RapprochementFacture {
  id               String   @id @default(cuid())
  societeId        String
  factureId        String
  paiementId       String?
  transactionBancaireId String? // Transaction bancaire liée
  montant          Decimal
  dateRapprochement DateTime @default(now())
  statut           String   @default("PENDING") // PENDING, VALIDATED, REJECTED
  scoreConfiance   Decimal? // Score de confiance du matching automatique (0-100)
  notes            String?  // Commentaires sur le rapprochement

  societe            Societe             @relation(fields: [societeId], references: [id])
  facture            Facture             @relation(fields: [factureId], references: [id])
  paiement           Paiement?           @relation(fields: [paiementId], references: [id])
  transactionBancaire TransactionBancaire? @relation(fields: [transactionBancaireId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId, statut])
  @@index([factureId])
  @@index([transactionBancaireId])
}

model Document {
  id           String   @id @default(cuid())
  societeId    String
  nom          String // Nom du fichier original
  type         String // FACTURE_FOURNISSEUR, JUSTIFICATIF, CONTRAT, AUTRE
  categorie    String? // Catégorisation manuelle (ex: "Achats", "Ventes", "Administratif")
  statut       String   @default("UPLOADED") // UPLOADED, VALIDATED, ARCHIVED
  cheminFichier String // Chemin du fichier sur le serveur
  dateUpload   DateTime @default(now())
  description  String? // Description optionnelle
  tailleFichier Int? // Taille en bytes
  mimeType     String? // Type MIME du fichier (ex: "application/pdf", "image/jpeg")
  texteExtrait String? // Texte extrait par OCR / extraction PDF

  societe Societe @relation(fields: [societeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId, statut])
  @@index([societeId, type])
}

model EcheanceFiscale {
  id              String   @id @default(cuid())
  societeId       String
  type            String   // TVA, IS, CNPS, DOUANES, RETENUE_SOURCE, AUTRE
  libelle         String   // "Déclaration TVA mensuelle", "Déclaration IS annuelle", etc.
  dateEcheance    DateTime // Date limite pour la déclaration/paiement
  periode         String?  // Période concernée (ex: "2024-01" pour TVA mensuelle, "2024" pour IS annuelle)
  statut          String   @default("A_FAIRE") // A_FAIRE, EN_COURS, FAITE, EN_RETARD, ANNULEE
  montantEstime   Decimal? // Montant estimé à payer (calculé automatiquement si possible)
  dateRealisation DateTime? // Date réelle de déclaration/paiement
  reference       String?  // Numéro de référence de la déclaration (si faite)
  notes           String?  // Notes optionnelles
  
  // Rappels envoyés
  rappel7Jours    Boolean  @default(false) // Rappel envoyé 7 jours avant
  rappel3Jours    Boolean  @default(false) // Rappel envoyé 3 jours avant
  rappelJourJ     Boolean  @default(false) // Rappel envoyé le jour J
  rappelRetard    Boolean  @default(false) // Rappel envoyé en cas de retard
  
  // Lien avec déclaration si applicable
  declarationTVAId String? // Si type = TVA, lien vers DeclarationTVA
  
  societe         Societe  @relation(fields: [societeId], references: [id])
  declarationTVA  DeclarationTVA? @relation(fields: [declarationTVAId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId, statut])
  @@index([societeId, type])
  @@index([dateEcheance])
  @@index([societeId, dateEcheance])
}

model Alerte {
  id              String   @id @default(cuid())
  societeId       String
  userId          String?  // Si null, alerte pour tous les utilisateurs de la société
  type            String   // FACTURE_IMPAYEE, ECHEANCE_FISCALE, ALERTE_TRESORERIE, ANOMALIE, etc.
  titre           String
  message         String
  severite        String   @default("MOYENNE") // HAUTE, MOYENNE, BASSE
  statut          String   @default("NON_LUE") // NON_LUE, LUE, IGNOREE, RESOLUE
  dateAlerte      DateTime @default(now())
  dateLecture     DateTime?
  dateResolution  DateTime?
  
  // Lien vers l'élément concerné
  lien            String?  // URL relative (ex: /factures/123)
  elementId       String?  // ID de l'élément (facture, échéance, etc.)
  elementType     String?  // Type d'élément (FACTURE, ECHEANCE_FISCALE, etc.)
  
  // Métadonnées JSON pour flexibilité
  metadata        Json?
  
  // Notifications envoyées
  emailEnvoye     Boolean  @default(false)
  smsEnvoye       Boolean  @default(false)
  inAppAffichee   Boolean  @default(false)
  
  societe         Societe  @relation(fields: [societeId], references: [id])
  user            User?    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([societeId, statut])
  @@index([societeId, type])
  @@index([userId, statut])
  @@index([dateAlerte])
  @@index([societeId, dateAlerte])
}

model Devise {
  id          String   @id @default(cuid())
  code        String   @unique // XOF, EUR, USD, etc.
  nom         String   // Franc CFA, Euro, Dollar US
  symbole     String   // FCFA, €, $
  estParDefaut Boolean  @default(false) // XOF par défaut pour Côte d'Ivoire
  actif       Boolean  @default(true)
  
  tauxChanges TauxChange[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TauxChange {
  id            String   @id @default(cuid())
  deviseId      String
  deviseBase    String   @default("XOF") // Toujours par rapport à XOF (FCFA)
  taux          Decimal  // 1 EUR = X XOF
  date          DateTime @default(now())
  source        String   @default("BCEAO") // BCEAO, MANUEL, API_PUBLIQUE
  
  devise        Devise   @relation(fields: [deviseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deviseId, date])
  @@index([date])
}
